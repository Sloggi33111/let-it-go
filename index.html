<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Pinterest-Style Image Gallery</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" async></script>
    <script src="https://cdn.jsdelivr.net/npm/imagesloaded@5/imagesloaded.pkgd.min.js" async></script>
</head>
<body>
    <h1>Welcome to My Image Gallery!</h1>
    
    <div class="search-container">
        <input type="text" id="search-input" placeholder="Search by filename...">
    </div>

    <div class="grid" id="grid">
        <div class="grid-sizer"></div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const grid = document.getElementById('grid');
            const searchInput = document.getElementById('search-input');
            let msnry; 
            let allGridItems = [];

            // 确保 Masonry 和 imagesLoaded 已加载
            function initializeGallery() {
                if (!window.Masonry || !window.imagesLoaded) {
                    setTimeout(initializeGallery, 50); // 如果库未加载，稍后重试
                    return;
                }

                fetch('images.json')
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to load images.json: ' + response.status);
                        return response.json();
                    })
                    .then(images => {
                        if (!images.length) console.warn('images.json is empty!');
                        
                        const fragment = document.createDocumentFragment();

                        images.forEach(src => {
                            const item = document.createElement('div');
                            item.className = 'grid-item';
                            
                            const img = document.createElement('img');
                            img.src = src;
                            img.alt = 'Image';
                            img.loading = 'lazy';
                            
                            img.onclick = () => {
                                const filename = src.split('/').pop();
                                navigator.clipboard.writeText(filename)
                                    .then(() => alert('Copied filename to clipboard: ' + filename))
                                    .catch(err => console.error('Failed to copy: ', err));
                            };
                            
                            item.appendChild(img);
                            fragment.appendChild(item);
                            allGridItems.push(item);
                        });
                        
                        grid.appendChild(fragment);

                        // 初始化 Masonry
                        imagesLoaded(grid, function() {
                            msnry = new Masonry(grid, {
                                itemSelector: '.grid-item',
                                columnWidth: '.grid-sizer',
                                gutter: 10,
                                percentPosition: true,
                                transitionDuration: '0.6s' // 添加过渡动画
                            });

                            // 布局完成后，将所有项设置为可见
                            grid.classList.add('loaded'); 
                        });
                    })
                    .catch(error => {
                        console.error('Error loading images:', error);
                        alert('Failed to load images. Check console for details.');
                    });
            }

            initializeGallery();

            // 搜索功能
            searchInput.addEventListener('input', function() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                
                // 隐藏或显示项目
                allGridItems.forEach(item => {
                    const filename = item.querySelector('img').src.split('/').pop().toLowerCase();
                    const isMatch = filename.includes(searchTerm);
                    // 直接修改类名来控制显示/隐藏，而不是 style.display
                    if (isMatch) {
                        item.classList.remove('hidden');
                    } else {
                        item.classList.add('hidden');
                    }
                });

                // 关键：告诉 Masonry 重新布局
                if (msnry) {
                    // 使用 reloadItems() 和 layout() 来处理动态添加/删除的项
                    msnry.reloadItems();
                    msnry.layout();
                }
            });
        });
    </script>
</body>
</html>
