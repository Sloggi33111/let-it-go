document.addEventListener('DOMContentLoaded', function() {
    const grid = document.getElementById('grid');
    const searchInput = document.getElementById('search-input');
    const loadingIndicator = document.getElementById('loading-indicator');

    let msnry;
    let allImages = [];
    let displayedImages = [];
    let currentIndex = 0;
    const batchSize = 20;
    let isLoading = false;

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    function loadNextBatch() {
        if (isLoading) return;
        isLoading = true;
        loadingIndicator.style.display = 'block';

        const batch = displayedImages.slice(currentIndex, currentIndex + batchSize);

        if (batch.length === 0) {
            loadingIndicator.style.display = 'none';
            isLoading = false;
            return;
        }

        const fragment = document.createDocumentFragment();
        const newItems = [];

        batch.forEach(imageInfo => {
            const item = document.createElement('div');
            item.className = 'grid-item';

            const img = document.createElement('img');
            img.src = imageInfo.thumbnail;
            img.alt = imageInfo.filename;
            img.loading = 'lazy';

            img.onclick = () => {
                const fullFilename = imageInfo.filename;
                const lastDotIndex = fullFilename.lastIndexOf('.');
                const filenameWithoutExt = (lastDotIndex > -1)
                    ? fullFilename.substring(0, lastDotIndex)
                    : fullFilename;

                navigator.clipboard.writeText(filenameWithoutExt)
                    .then(() => {
                        alert('Copied: ' + filenameWithoutExt);
                    })
                    .catch(err => {
                        console.error('Failed to copy filename: ', err);
                        alert('Sorry, could not copy the name.');
                    });
            };

            item.appendChild(img);
            fragment.appendChild(item);
            newItems.push(item);
        });

        grid.appendChild(fragment);

        // 使用 imagesLoaded 确保图片加载完成后再进行布局
        imagesLoaded(grid).on('progress', function() {
            if (msnry) {
                // 核心改动：在图片加载过程中持续触发布局
                msnry.layout();
            }
        }).on('done', function() {
            // 所有图片加载完成后再次确保布局
            if (msnry) {
                // 将新加载的元素添加到 Masonry 实例中
                msnry.appended(newItems);
            }
            currentIndex += batch.length;
            isLoading = false;
            loadingIndicator.style.display = 'none';
        });
    }

    function filterImages() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        
        // 1. 获取所有当前的 grid-item 元素
        const items = grid.querySelectorAll('.grid-item');
        
        // 2. 从 Masonry 实例中移除它们
        if (msnry && items.length > 0) {
            msnry.remove(items);
        }
        
        // 3. 从 DOM 中移除它们
        items.forEach(item => item.remove());

        // 4. 重置数据和索引
        displayedImages = allImages.filter(img => img.filename.toLowerCase().includes(searchTerm));
        currentIndex = 0;
        
        // 5. 重新布局并加载新数据
        if (msnry) {
            msnry.layout();
        }
        loadNextBatch();
    }

    function initializeGallery() {
        if (!window.Masonry || !window.imagesLoaded) {
            setTimeout(initializeGallery, 50);
            return;
        }

        msnry = new Masonry(grid, {
            itemSelector: '.grid-item',
            columnWidth: '.grid-sizer',
            gutter: 10,
            percentPosition: true,
            transitionDuration: 0 // 建议在动态加载时禁用动画，避免闪烁
        });

        fetch('images.json')
            .then(response => response.json())
            .then(imageUrls => {
                allImages = imageUrls.map(url => ({
                    thumbnail: url,
                    full: url,
                    filename: url.split('/').pop()
                }));
                displayedImages = allImages;
                loadNextBatch();
            })
            .catch(console.error);
    }

    initializeGallery();
    searchInput.addEventListener('input', debounce(filterImages, 300));
    window.addEventListener('scroll', () => {
        // 优化滚动加载条件
        if (window.innerHeight + window.scrollY >= document.documentElement.scrollHeight - 500 && !isLoading && currentIndex < displayedImages.length) {
            loadNextBatch();
        }
    });
});
